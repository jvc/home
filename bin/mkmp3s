#!/bin/zsh

DSTDIR="$HOME/mp3"

setopt sh_wordsplit

for fname in $@; do
    OUTF=`echo "$fname" | tr "/" "-" | sed s/\.flac$/.mp3/g`

    if [[ -f "$DSTDIR/$OUTF" ]]; then
        print "SKIP $OUTF (already exists)"
        continue
    fi

    ARTIST=`metaflac "$fname" --show-tag=ARTIST | sed s/.\*=//g`
    TITLE=`metaflac "$fname" --show-tag=TITLE | sed s/.\*=//g`
    ALBUM=`metaflac "$fname" --show-tag=ALBUM | sed s/.\*=//g`
    GENRE=`metaflac "$fname" --show-tag=GENRE | sed s/.\*=//g`
    TRACKNUMBER=`metaflac "$fname" --show-tag=TRACKNUMBER | sed s/.\*=//g`
    DATE=`metaflac "$fname" --show-tag=DATE | sed s/.\*=//g`

    flac -c -d "$fname" | lame --noreplaygain -V0 \
        -v -b 256 \
        --add-id3v2 --pad-id3v2 --ignore-tag-errors \
        --tt "$TITLE" --tn "${TRACKNUMBER:-0}" \
        --ta "$ARTIST" --tl "$ALBUM" \
        --ty "$DATE" --tg "${GENRE:-12}" \
          - "$DSTDIR/$OUTF"
done
